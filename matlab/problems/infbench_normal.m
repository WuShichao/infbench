function [y,y_std] = infbench_normal(x,infprob)
%INFBENCH_NORMAL Inference benchmark log pdf -- multivariate normal density.

if isempty(x)
    if isempty(infprob) % Generate this document        
        fprintf('switch D\n');
        for D = 1:20
            Mu = 2*rand(1,D)-1;
            Sigma = exp(randn(1,D));
            fprintf('\tcase %d\n',D);
            fprintf('\t\tMu = %s;\n',mat2str(Mu));
            fprintf('\t\tSigma = %s;\n',mat2str(Sigma));
        end
        fprintf('\totherwise\n\t\terror(''%s:TooHighDim'',''Benchmark function supports up to D=20 dimensions.'');\n',mfilename);
        fprintf('end\n');
        
    else
        D = infprob(1);         % Call with the number of dimensions
        
        switch D
            case 1
                Mu = 0.249287073557449;
                Sigma = 1.86348784714191;
            case 2
                Mu = [0.825461886500333 0.948517591388057];
                Sigma = [7.74267403837355 2.36360895523857];
            case 3
                Mu = [-0.374905515536755 -0.788573051555007 -0.975128830539174];
                Sigma = [1.38498196825496 0.441979937654847 0.399928438261816];
            case 4
                Mu = [0.152128291669949 0.647706023301583 -0.867542988379633 -0.505226646243582];
                Sigma = [0.299009232962339 0.865543399580464 6.32902044406306 0.557657017084747];
            case 5
                Mu = [0.377729803226587 -0.539733681346623 -0.48542380079806 -0.783794378190754 -0.750555741787954];
                Sigma = [0.728723780058907 2.42343003114337 2.5931546236858 0.826408285973475 0.89262458946474];
            case 6
                Mu = [0.189208828196455 0.429740583700097 0.732245429379498 0.739936771908301 -0.927213276569572 0.322131020728829];
                Sigma = [0.326279547196407 0.400248933357724 0.904083899569652 0.733377951964839 0.964401897597425 4.68253911452903];
            case 7
                Mu = [-0.0899449622256407 -0.136245388202654 0.233682080291836 0.669228966181511 -0.733523226697633 0.919484739375708 0.252603069663069];
                Sigma = [0.149648144284689 1.00565999949517 0.413133503795867 0.983417377289517 4.76308037195402 0.696538829000159 2.12744760713708];
            case 8
                Mu = [-0.267173456031077 -0.285448983658087 0.705467554828749 0.999651768702852 -0.026847635224535 0.887647736169442 0.81288478431422 -0.41766600793346];
                Sigma = [5.322273428742 0.792910447694951 0.458997063835096 3.54433360102321 0.38630284944982 0.79981979643649 1.57978714163762 5.45942205207974];
            case 9
                Mu = [0.835002803586829 0.277260347045039 -0.848759515491691 0.397185772654918 0.798943348978861 -0.926483880653226 0.55531719194267 0.574151869392455 0.0328698297223866];
                Sigma = [1.56096440402113 0.923323478491776 1.07421382203879 2.49353446646153 0.477509493915287 0.924539710270236 2.59322978880763 3.73262459149527 0.555101194674068];
            case 10
                Mu = [0.760476972148073 0.668255594655636 -0.607510067590848 0.917254219231881 0.753972082356166 0.509440182367335 -0.32175819032936 -0.971965049294744 -0.0678204018328088 0.619708068708667];
                Sigma = [5.0066242514527 1.1192158651786 0.820255845032657 2.25290054705004 0.274704200036936 1.29782183320026 0.976978860460357 0.29958008732077 1.53075548837201 3.70782025234869];
            case 11
                Mu = [-0.219559006546558 0.360743847431603 -0.115619744090145 0.877633933360254 0.400932257313136 -0.99237429245735 0.743237437453773 0.920331651594206 -0.588799867857246 -0.335799942567 -0.823508104008609];
                Sigma = [0.598076769797149 0.811833483579133 1.91891448367835 2.41576979497778 0.423889812848835 0.749572324161237 0.273473104722189 0.298495988260645 2.03672508726869 0.347057372618292 0.341642086372526];
            case 12
                Mu = [0.868213510585915 -0.0570804695823728 -0.0164254603827132 -0.319667370997705 0.561924885869559 0.933099309389297 0.870608563315715 0.194796571773211 0.800816520412262 -0.0949560956632041 -0.529515666265755 -0.360530141620653];
                Sigma = [9.44277155497507 1.16030438375099 0.508878245425147 0.3571548012575 0.297986880592974 1.0448574742414 0.21414847265681 0.846904076535248 3.01427336712814 0.350052769488731 0.415880897694968 6.63309522800301];
            case 13
                Mu = [-0.685191990930567 -0.245705188380202 0.514538875288977 0.88644458106343 -0.207376699057901 0.706648715046907 -0.927751775299615 0.846203478223074 0.707469249638514 -0.738210039900491 0.548879384304599 0.358080928171404 0.168902974793543];
                Sigma = [3.1885648461486 1.93628828022851 0.956160702898241 0.821141595932467 3.59196191023091 2.70810852631367 4.28664171409476 0.294806286535326 0.831438794880653 3.50923968499392 0.398608581627541 1.05737951185347 0.277219533897515];
            case 14
                Mu = [0.509284866213514 -0.75211656516858 0.591898058437831 0.81773542237566 0.809185536171621 -0.305334783061852 0.768067171543327 -0.866117792545844 -0.61491295059703 -0.123344370523324 0.581055544777374 -0.345595750180465 -0.866551442080609 0.103176463869096];
                Sigma = [6.45871743571505 0.476720323682772 2.0842507715452 1.18650125746516 2.70538471357482 1.42504938714562 4.15917775930812 0.691033170982874 1.39175190478781 0.2389469287301 2.89850375373031 0.881859626244303 0.775057170853161 1.68914595340805];
            case 15
                Mu = [-0.28640059768658 -0.904638828880673 -0.769808808944755 0.111209499712061 -0.595745561176011 0.0921459576850308 0.949054916705588 -0.798934603768656 -0.520105723561462 0.449073446534348 -0.526391226205481 -0.204445064657905 0.828966515606302 -0.77083240694331 0.716440759864273];
                Sigma = [0.176985368179735 6.51802428893955 1.10948074868139 2.57692301844461 0.383833420333134 0.833569415280938 1.35136386531499 3.16145143105514 1.26331986157014 0.814902032373922 0.147928365858583 4.37346856667175 2.60127337664204 1.622610535291 0.953407867450527];
            case 16
                Mu = [-0.121602604898884 -0.265718465103111 0.130902790441109 0.81027544234158 0.493180492404087 0.31910402896851 0.667508154892872 -0.949257402268188 -0.874021508892568 -0.301864580611791 0.0692881491704638 0.0914401536990126 0.71718565718749 -0.933475152695081 0.473408087967558 0.0503832218341675];
                Sigma = [6.37972425956118 0.471134240312234 0.289301786862296 2.84704752026346 0.113771534719572 0.887094444835859 2.20933272015486 0.712587230009624 9.78019646985755 1.23915247187402 0.618238409251964 1.9333506464613 0.474711767444869 0.446573549528493 1.34244941257026 0.924021792453801];
            case 17
                Mu = [0.174865476157859 -0.607559844418504 -0.367095632103584 -0.637133099061767 0.00393208092430264 0.063807365729101 0.303362587836308 -0.421043839115429 0.537411639867968 -0.869408298118762 0.521471471986357 -0.587780278683484 0.816971042017145 -0.632441070507107 -0.257863077295335 0.0155215537428774 -0.638491078049391];
                Sigma = [0.948845346579247 1.1231880665469 1.4761183067119 0.60043756317868 0.230593272261166 4.69270190714946 1.8408689596915 4.67491494113807 0.883162365871401 0.960560089294853 0.968945999962592 2.02873526528764 1.14156854263632 0.506031009558446 1.64704002314706 2.69650505823931 0.0987683193569299];
            case 18
                Mu = [-0.620732012778992 -0.88162101271025 -0.466495772913422 -0.428126134404113 0.043944281536215 -0.181939989332177 0.68783601442492 -0.158157907231881 0.24528719018725 -0.178435147085066 0.16139438347333 0.489183974425521 0.264964266715742 0.60189550447236 -0.510701061172159 0.284672122450803 -0.461211464879988 -0.126220758786225];
                Sigma = [2.59629238130209 0.483870764632191 1.60176288649228 1.16472669303581 2.47485006924791 0.340023473809795 6.14768777908281 0.504024493951185 0.38653194605769 0.238566984429799 1.7499477798294 0.386900182163785 0.915109532388939 0.919074172293512 0.330732940292739 0.946568387532924 0.331780130901231 0.945363846869953];
            case 19
                Mu = [0.963959669743613 -0.387991592695114 0.117264011563462 0.343286795595444 -0.829557957283455 0.384177271284027 0.0374107875018284 0.769249046492614 0.0694839550161228 -0.829701917021397 -0.837821962946407 0.491020968510763 -0.629435395815795 0.215054961149096 0.676652419385288 -0.179621447474348 0.960233794362718 0.00212187058608126 -0.479468962849043];
                Sigma = [0.469794793247614 0.773520709588304 0.794419115933549 1.19643344064583 0.426400749284696 0.913069465506665 0.494600992270989 2.69587381170849 2.26330310586667 0.952144437148121 0.267866803193798 0.868896276412066 1.13373842016175 1.06568464748417 0.222491989202034 0.238209199380355 0.970454870917807 0.878870308762186 1.48069885380413];
            case 20
                Mu = [-0.713542420657898 -0.8379606722615 -0.52918466610447 0.747901331777859 -0.755918323148113 0.360597618864864 0.865062198422911 -0.377616709596858 -0.175755373598203 -0.97163230902882 0.0753136333205957 0.153209763717076 -0.909853977911946 0.449298748595115 0.434934018959165 0.191309937072916 -0.129320898524909 0.738098096496346 0.438503026634639 -0.772094326701284];
                Sigma = [2.89421086755246 0.550475875313809 0.164786756094268 2.40910185004181 0.254610303924969 0.177257684897827 0.227329524873947 0.646236545838602 1.71427515730237 1.18064343683426 2.70889331311843 0.890381520359304 1.21545664758487 1.02269387866299 1.73150463763604 0.522185012924456 0.760137136129888 0.468323416518335 0.198474628980842 1.71670877146045];
            otherwise
                error('infbench_normal:TooHighDim','Benchmark function supports up to D=20 dimensions.');
        end        
        
        
        y.func = ['@(x,infprob) ' mfilename '(x,infprob)'];
        
        Mean = Mu;
        Cov = diag(Sigma.^2);
        Mode = Mu;
                
        y.D = D;
        y.LB = -Inf(1,D);
        y.UB = Inf(1,D);
        y.PLB = -1 - 3*sqrt(diag(Cov))';
        y.PUB = 1 + 3*sqrt(diag(Cov))';
        y.lnZ = 0;        % Log normalization factor
        y.Mu = Mu;
        y.Sigma = Sigma;
        y.Mean = Mean;        % Distribution moments
        y.Cov = Cov;
        y.Mode = Mode;        % Mode of the pdf
        
        priorMean = 0.5*(y.PUB + y.PLB);
        priorSigma2 = (0.5*(y.PUB - y.PLB)).^2;
        priorCov = diag(priorSigma2);
        y.Prior.Mean = priorMean;
        y.Prior.Cov = priorCov;
        
        % Compute each coordinate separately
        y.Post.Mean = zeros(1,D);
        PostSigma2 = zeros(1,D);
        y.Post.Mode = zeros(1,D);
        range = 5*(y.PUB-y.PLB);
        Z = zeros(1,D);
        for i = 1:D
            % Compute normalization constant
            fun = @(x_) normpdf(x_,Mu(i),Sigma(i)) .* normpdf(x_,priorMean(i),sqrt(priorSigma2(i)));
            Z(i) = integral(fun,y.PLB(i)-range(i),y.PUB(i)+range(i));
            
            % Compute mean
            fun = @(x_) x_.* normpdf(x_,Mu(i),Sigma(i)) .* normpdf(x_,priorMean(i),sqrt(priorSigma2(i)));
            y.Post.Mean(i) = integral(fun,y.PLB(i)-range(i),y.PUB(i)+range(i))/Z(i);
                        
            % Compute variance
            fun = @(x_) x_.^2.* normpdf(x_,Mu(i),Sigma(i)) .* normpdf(x_,priorMean(i),sqrt(priorSigma2(i)));
            PostSigma2(i) = integral(fun,-Inf,Inf)/Z(i) - y.Post.Mean(i)^2;            
            
            % Compute mode
            options.Display = 'off';
            np = @(x_) -normpdf(x_,Mu(i),Sigma(i)) .* normpdf(x_,priorMean(i),sqrt(priorSigma2(i)));
            y.Post.Mode(i) = fminunc(np,y.Post.Mean(i),options);            
        end
                
        y.Post.lnZ = sum(log(Z));
        y.Post.Cov = diag(PostSigma2);        
    end
elseif nargout > 0
    
    mu = infprob.Mu;
    sigma = infprob.Sigma;
    
    y = zeros(size(x,1),1);
    for i = 1:infprob.D
        y = y + normlogpdf(x(:,i),mu(i),sigma(i));
    end
    y_std = zeros(size(x,1),1);
else
    Nrnd = 1e5;
    D = infprob.D;
    xrnd = zeros(Nrnd,D);
    for i = 1:D
        xrnd(:,i) = randn([Nrnd,1])*infprob.Sigma(i) + infprob.Mu(i);
    end
    cornerplot(xrnd);
end

end